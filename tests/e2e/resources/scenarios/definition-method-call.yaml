name: definition-method-call
description: Goto definition from method call sites.
workspace:
  fixture: gradle-dependency
steps:
  - initialize: {}
  - initialized: {}
  
  # Setup
  - openDocument:
      path: src/main/groovy/CallSite.groovy
      languageId: groovy
      version: 1
      text: |
        class Target {
            void targetMethod() { // Line 1
                println "Target"
            }
        }
        
        class Caller {
            void run() {
                Target t = new Target()
                t.targetMethod() // Line 7
            }
        }

  - waitNotification:
      method: groovy/status
      checks:
        - jsonPath: $.health
          expect:
            type: EQUALS
            value: ok
        - jsonPath: $.quiescent
          expect:
            type: EQUALS
            value: true
      timeoutMs: 30000

  # Request definition on 'targetMethod' call at line 9 (0-indexed)
  - request:
      method: textDocument/definition
      params:
        textDocument:
          uri: "{{workspace.uri}}src/main/groovy/CallSite.groovy"
        position:
          line: 9
          character: 15
      saveAs: definitionResult

  - assert:
      source: definitionResult
      checks:
        - jsonPath: $.items.length()
          expect:
            type: EQUALS
            value: 1
        - jsonPath: $.items[0].uri
          expect:
            type: CONTAINS
            value: "CallSite.groovy"
        - jsonPath: $.items[0].range.start.line
          expect:
            type: EQUALS
            value: 1 # Line 1 where targetMethod is defined

  - shutdown: {}
  - exit: {}
