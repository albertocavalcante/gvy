name: signature-help-basic
description: >
  Test textDocument/signatureHelp.
  Verifies that available signatures are returned for a method call.
workspace:
  fixture: empty-workspace
steps:
  - initialize: {}
  - initialized: {}
  - waitNotification:
      method: groovy/status
      checks:
        - jsonPath: $.status
          expect:
            type: EQUALS
            value: Ready
      timeoutMs: 60000

  - openDocument:
      path: src/SigHelpTest.groovy
      languageId: groovy
      version: 1
      text: |
        class SigHelpTest {
            void method() {
                println()
            }
        }
  
  - waitNotification:
      method: textDocument/publishDiagnostics
      timeoutMs: 10000

  # Trigger signature help inside parens of println()
  # Line 2 ("        println()"). 4 tabs = 8 spaces (if converted)? or just spaces?
  # Text: "        println()"
  # Indices:
  # 0-7: spaces
  # 8-14: println
  # 15: (
  # 16: )
  # We want position 16 (after '(') or 15 (at '(')?
  # Usually inside parens is index of '(' + 1. So 16.
  - request:
      method: textDocument/signatureHelp
      params:
        textDocument:
          uri: "{{workspace.uri}}src/SigHelpTest.groovy"
        position:
          line: 2
          character: 16
      saveAs: sigHelpResult

  # Verify signatures
  - assert:
      source: sigHelpResult
      checks:
        # Check that we got println overloads from groovy.lang.Script
        - jsonPath: $.signatures.length()
          expect:
            type: EQUALS
            value: 2
            message: "Expected 2 println() overloads from groovy.lang.Script"

        # Check that activeSignature is set
        - jsonPath: $.activeSignature
          expect:
            type: EQUALS
            value: 0
            
        # Check activeParameter is 0 (cursor at first param position)
        - jsonPath: $.activeParameter
          expect:
            type: EQUALS
            value: 0

        # TODO(#466): Add strict label assertions once we improve signature formatting
        #   Currently signatures use simplified format "println()" without modifiers.
        #   Ideal format: "public void println()" matching IDE conventions.
        # - jsonPath: $.signatures[?(@.label == 'public void println()')]
        #   expect:
        #     type: SIZE
        #     value: 1
        #     message: "Should find 'public void println()' signature"

  - shutdown: {}
  - exit: {}
