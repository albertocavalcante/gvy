name: completion-basic
description: Request completion for println in a simple Groovy class with strict assertions.
workspace:
  fixture: completion-basic
steps:
  - initialize: {}
  - initialized: {}
  # Wait for server to be ready before making requests
  - waitNotification:
      method: groovy/status
      checks:
        - jsonPath: $.health
          expect:
            type: EQUALS
            value: ok
        - jsonPath: $.quiescent
          expect:
            type: EQUALS
            value: true
      timeoutMs: 180000
  - openDocument:
      path: src/Main.groovy
      languageId: groovy
      version: 1
      text: |
        class Main {
            def run() {
                prin
            }
        }
  - request:
      method: textDocument/completion
      params:
        textDocument:
          uri: "{{workspace.uri}}src/Main.groovy"
        position:
          line: 2
          character: 16
      saveAs: completion
      extract:
        - variable: completion.items
          jsonPath: $.items

  # Strict: completions must not be empty
  - assert:
      source: completion
      checks:
        - jsonPath: $.items
          expect:
            type: NOT_EMPTY

  # Strict: println must be in the results
  - assert:
      source: completion
      checks:
        - jsonPath: $.items[*].label
          expect:
            type: CONTAINS
            value: println

  # Strict: print should also be available (prefix matches)
  - assert:
      source: completion.items
      checks:
        - jsonPath: $[*].label
          expect:
            type: CONTAINS
            value: print

  # Strict: verify println item exists (per Gemini review - combined check)
  - assert:
      source: completion.items
      checks:
        - jsonPath: "$[?(@.label == 'println')]"
          expect:
            type: NOT_EMPTY
            message: Should have println completion item

  # Strict: verify println signature detail is present
  - assert:
      source: completion.items
      checks:
        - jsonPath: $[*].detail
          expect:
            type: CONTAINS
            value: "void println(Object)"

  # Strict: Local symbols should be present
  - assert:
      source: completion.items
      checks:
        - jsonPath: $[*].label
          expect:
            type: CONTAINS
            value: Main
        - jsonPath: $[*].label
          expect:
            type: CONTAINS
            value: run

  - shutdown: {}
  - exit: {}
