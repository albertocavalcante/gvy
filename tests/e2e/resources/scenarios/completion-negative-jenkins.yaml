name: completion-negative-jenkins
description: >
  Negative test: Regular Groovy files should NOT have Jenkins pipeline step completions.
  This verifies that sh, echo, bat, powershell, checkout, currentBuild are NOT offered
  unless the file is identified as a Jenkins pipeline (Jenkinsfile pattern).
workspace:
  fixture: completion-basic
steps:
  - initialize: {}
  - initialized: {}
  # Wait for server to be ready before making requests
  - waitNotification:
      method: groovy/status
      checks:
        - jsonPath: $.health
          expect:
            type: EQUALS
            value: ok
        - jsonPath: $.quiescent
          expect:
            type: EQUALS
            value: true
      timeoutMs: 180000

  # Test 1: Regular .groovy file should NOT have Jenkins 'echo' step
  - openDocument:
      path: src/RegularClass.groovy
      languageId: groovy
      version: 1
      text: |
        class RegularClass {
            def run() {
                ech
            }
        }
  - request:
      method: textDocument/completion
      params:
        textDocument:
          uri: "{{workspace.uri}}src/RegularClass.groovy"
        position:
          line: 2
          character: 11
      saveAs: echoCompletion

  # First verify completions work (NOT_EMPTY to catch broken completion system)
  - assert:
      source: echoCompletion
      checks:
        - jsonPath: $.items
          expect:
            type: NOT_EMPTY
            message: Completions should return results for 'ech' prefix

  # Negative assertion: Jenkins 'echo' step should NOT be in completions
  - assert:
      source: echoCompletion
      checks:
        - jsonPath: $.items[*].detail
          expect:
            type: NONE_CONTAINS
            value: "Jenkins step"

  # Test 2: Regular .groovy file should NOT have Jenkins 'sh' step
  - changeDocument:
      path: src/RegularClass.groovy
      version: 2
      text: |
        class RegularClass {
            def run() {
                sh
            }
        }
  - request:
      method: textDocument/completion
      params:
        textDocument:
          uri: "{{workspace.uri}}src/RegularClass.groovy"
        position:
          line: 2
          character: 10
      saveAs: shCompletion

  # First verify completions work
  - assert:
      source: shCompletion
      checks:
        - jsonPath: $.items
          expect:
            type: NOT_EMPTY
            message: Completions should return results for 'sh' prefix

  # Negative assertion: Jenkins 'sh' step should NOT be in completions
  - assert:
      source: shCompletion
      checks:
        - jsonPath: $.items[*].detail
          expect:
            type: NONE_CONTAINS
            value: "Jenkins step"

  # Test 3: Verify currentBuild global variable is NOT available
  - changeDocument:
      path: src/RegularClass.groovy
      version: 3
      text: |
        class RegularClass {
            def run() {
                currentBui
            }
        }
  - request:
      method: textDocument/completion
      params:
        textDocument:
          uri: "{{workspace.uri}}src/RegularClass.groovy"
        position:
          line: 2
          character: 18
      saveAs: currentBuildCompletion

  # Note: currentBuild prefix may not match many normal completions, 
  # so we check NOT_CONTAINS without NOT_EMPTY requirement
  # Negative assertion: Jenkins 'currentBuild' global should NOT be in completions
  - assert:
      source: currentBuildCompletion
      checks:
        - jsonPath: $.items[*].label
          expect:
            type: NOT_CONTAINS
            value: currentBuild

  - shutdown: {}
  - exit: {}
