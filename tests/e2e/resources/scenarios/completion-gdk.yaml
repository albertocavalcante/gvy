name: completion-gdk
description: Request completion for GDK methods and type parameters with strict assertions.
workspace:
  fixture: completion-basic
steps:
  - initialize: {}
  - initialized: {}
  # Wait for server to be ready before making requests
  - waitNotification:
      method: groovy/status
      checks:
        - jsonPath: $.health
          expect:
            type: EQUALS
            value: ok
        - jsonPath: $.quiescent
          expect:
            type: EQUALS
            value: true
      timeoutMs: 180000

  # Test GDK completion on List
  - openDocument:
      path: src/GdkTest.groovy
      languageId: groovy
      version: 1
      text: |
        def myList = [1, 2, 3]
        myList.
  - request:
      method: textDocument/completion
      params:
        textDocument:
          uri: "{{workspace.uri}}src/GdkTest.groovy"
        position:
          line: 1
          character: 7
      saveAs: completion_gdk
      extract:
        - variable: completion_gdk.items
          jsonPath: $.items

  # Strict: GDK completions must not be empty
  - assert:
      source: completion_gdk
      checks:
        - jsonPath: $.items
          expect:
            type: NOT_EMPTY

  # Strict: Core GDK methods must be present
  - assert:
      source: completion_gdk
      checks:
        - jsonPath: $.items[*].label
          expect:
            type: CONTAINS
            value: each
        - jsonPath: $.items[*].label
          expect:
            type: CONTAINS
            value: collect
        - jsonPath: $.items[*].label
          expect:
            type: CONTAINS
            value: find
        - jsonPath: $.items[*].label
          expect:
            type: CONTAINS
            value: findAll

  # Strict: More GDK List methods
  - assert:
      source: completion_gdk
      checks:
        - jsonPath: $.items[*].label
          expect:
            type: CONTAINS
            value: first
        - jsonPath: $.items[*].label
          expect:
            type: CONTAINS
            value: last
        - jsonPath: $.items[*].label
          expect:
            type: CONTAINS
            value: sort

  # Test Type Parameter completion
  - openDocument:
      path: src/TypeParamTest.groovy
      languageId: groovy
      version: 1
      text: |
        List<Str
  - request:
      method: textDocument/completion
      params:
        textDocument:
          uri: "{{workspace.uri}}src/TypeParamTest.groovy"
        position:
          line: 0
          character: 8
      saveAs: completion_type
      extract:
        - variable: completion_type.items
          jsonPath: $.items

  # Strict: Type completions must not be empty
  - assert:
      source: completion_type
      checks:
        - jsonPath: $.items
          expect:
            type: NOT_EMPTY

  # Strict: String type must be in completions
  - assert:
      source: completion_type
      checks:
        - jsonPath: $.items[*].label
          expect:
            type: CONTAINS
            value: String

  - shutdown: {}
  - exit: {}
