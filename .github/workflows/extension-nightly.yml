name: Extension Nightly

on:
  schedule:
    - cron: "0 3 * * *" # Daily at 03:00 UTC
  workflow_dispatch:
    inputs:
      ref:
        description: "Ref to build from"
        required: false
        default: "main"
      use_latest_lsp:
        description: "Use the latest Groovy LSP (instead of pinned)"
        required: false
        type: boolean
        default: false
      skip_tests:
        description: "Skip test suite"
        required: false
        type: boolean
        default: false
      publish_prerelease:
        description: "Publish a GitHub prerelease with the nightly VSIX attached"
        required: false
        type: boolean
        default: false

defaults:
  run:
    working-directory: editors/code

jobs:
  nightly:
    timeout-minutes: 30
    permissions:
      contents: write
    runs-on: ubuntu-latest
    env:
      REQUIRE_SERVER_BUNDLE: true
      USE_LATEST_LSP_INPUT: ${{ github.event.inputs.use_latest_lsp || 'false' }}
      SKIP_TESTS_INPUT: ${{ github.event.inputs.skip_tests || 'false' }}
      PUBLISH_PRERELEASE_INPUT: ${{ github.event.inputs.publish_prerelease || 'false' }}

    steps:
      - name: Validate ref input
        if: github.event.inputs.ref != ''
        shell: bash
        env:
          REF_INPUT: ${{ github.event.inputs.ref }}
        run: |
          # Validate ref matches expected formats: branch names or commit SHAs
          # Allowed: main, feature/foo, v1.2.3, 40-char hex SHA
          if [[ ! "$REF_INPUT" =~ ^[a-zA-Z0-9][a-zA-Z0-9._/-]*$ ]] && \
             [[ ! "$REF_INPUT" =~ ^[0-9a-f]{40}$ ]]; then
            echo "::error::Invalid ref format: $REF_INPUT"
            exit 1
          fi
          echo "Ref validation passed: $REF_INPUT"

      - name: Determine checkout ref
        id: checkout_ref
        shell: bash
        env:
          REF_INPUT: ${{ github.event.inputs.ref }}
        run: |
          # Use validated input or default to main
          CHECKOUT_REF="${REF_INPUT:-main}"
          echo "ref=${CHECKOUT_REF}" >> "$GITHUB_OUTPUT"

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ steps.checkout_ref.outputs.ref }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: 24

      - name: Setup pnpm
        uses: pnpm/action-setup@9fd676a19091d4595eefd76e4bd31c97133911f1 # v4.2.0
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> "$GITHUB_ENV"

      - name: Cache pnpm store
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('editors/code/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Java
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5
        with:
          distribution: temurin
          java-version: 17

      - name: Compute Groovy LSP cache key
        id: groovy_lsp_cache
        if: env.USE_LATEST_LSP_INPUT != 'true'
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          node tools/compute-groovy-cache-key.js >> "$GITHUB_OUTPUT"

      - name: Cache Groovy LSP
        if: env.USE_LATEST_LSP_INPUT != 'true'
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5
        with:
          path: |
            editors/code/server/groovy-lsp.jar
            editors/code/server/.groovy-lsp-version
          key: groovy-lsp-${{ runner.os }}-${{ steps.groovy_lsp_cache.outputs.tag }}-${{ steps.groovy_lsp_cache.outputs.hash }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SKIP_PREPARE_SERVER: false
          USE_LATEST_GROOVY_LSP: ${{ env.USE_LATEST_LSP_INPUT }}

      - name: Compute nightly version
        id: nightly_version
        shell: bash
        run: |
          set -euo pipefail
          BASE_VERSION=$(node -p "require('./package.json').version.split('-')[0]")
          NIGHTLY_VERSION="${BASE_VERSION}-nightly.$(date -u +%Y%m%d%H%M)"
          pnpm version "$NIGHTLY_VERSION" --no-git-tag-version
          echo "nightly_version=$NIGHTLY_VERSION" >> "$GITHUB_OUTPUT"
          echo "nightly_tag=nightly-${NIGHTLY_VERSION}-${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"

      - name: Build extension
        run: pnpm run compile

      - name: Run tests
        if: env.SKIP_TESTS_INPUT != 'true'
        run: |
          /usr/bin/Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
          export DISPLAY=:99
          pnpm test

      - name: Package VSIX
        run: pnpm run package
        env:
          SKIP_PREPARE_SERVER: true

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: vsix-nightly-${{ steps.nightly_version.outputs.nightly_version }}
          path: editors/code/*.vsix
          retention-days: 7

      - name: Publish prerelease (GitHub only)
        if: env.PUBLISH_PRERELEASE_INPUT == 'true'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          tag_name: ${{ steps.nightly_version.outputs.nightly_tag }}
          name: Extension Nightly ${{ steps.nightly_version.outputs.nightly_version }}
          prerelease: true
          generate_release_notes: false
          files: editors/code/*.vsix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
