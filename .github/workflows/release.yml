name: Release
"on":
  push:
    tags:
    - v*
  workflow_dispatch:
    inputs:
      runner_label:
        description: 'Runner label to use'
        required: false
        type: choice
        options:
          - 'github-hosted'
          - 'self-hosted'
          - 'local-macos'
          - 'magalu'
        default: 'github-hosted'
      tag:
        description: 'Tag to release (for re-running failed releases)'
        required: false
        type: string
      dry_run:
        description: Dry run (don't create release)
        required: false
        type: boolean
        default: false
      disable_scan:
        description: Disable Gradle build scan
        required: false
        type: boolean
        default: false
jobs:
  build-release:
    name: Build Release Artifacts
    permissions:
      contents: read
    timeout-minutes: 60
    runs-on: ${{ matrix.os == 'self-hosted' && 'self-hosted' || matrix.os == 'local-macos' && fromJSON('["self-hosted", "local-macos", "groovy-lsp"]') || matrix.os == 'magalu' && fromJSON('["self-hosted", "magalu", "groovy-lsp"]') || matrix.os }}
    outputs:
      build_version: ${{ steps.set-env.outputs.build_version }}
      build_commit: ${{ steps.set-env.outputs.build_commit }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ${{ (github.event.inputs.runner_label == 'self-hosted' || vars.CI_RUNNER_LABEL == 'self-hosted') && 'self-hosted' || (github.event.inputs.runner_label == 'local-macos' || vars.CI_RUNNER_LABEL == 'local-macos') && 'local-macos' || (github.event.inputs.runner_label == 'magalu' || vars.CI_RUNNER_LABEL == 'magalu') && 'magalu' || 'ubuntu-24.04' }}
        java:
          - 17
    steps:
    - name: Validate tag input
      if: github.event.inputs.tag != ''
      shell: bash
      env:
        TAG_INPUT: ${{ github.event.inputs.tag }}
      run: |
        # Validate tag matches expected version format (v1.2.3 or v1.2.3-rc.1 or vscode-groovy-v1.2.3)
        if [[ ! "$TAG_INPUT" =~ ^(v|vscode-groovy-v)?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
          echo "::error::Invalid tag format: $TAG_INPUT. Expected formats: v1.2.3, v1.2.3-rc.1, or vscode-groovy-v1.2.3"
          exit 1
        fi
        echo "Tag validation passed: $TAG_INPUT"

    - name: Determine checkout ref
      id: checkout_ref
      shell: bash
      env:
        TAG_INPUT: ${{ github.event.inputs.tag }}
        DEFAULT_REF: ${{ github.ref }}
      run: |
        # Use validated tag input or fall back to github.ref
        CHECKOUT_REF="${TAG_INPUT:-$DEFAULT_REF}"
        echo "ref=${CHECKOUT_REF}" >> "$GITHUB_OUTPUT"

    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0
        ref: ${{ steps.checkout_ref.outputs.ref }}
        persist-credentials: false
    - name: "Set up JDK ${{ matrix.java }}"
      uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
      with:
        distribution: temurin
        java-version: "${{ matrix.java }}"
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
      with:
        cache-read-only: false
    - name: Set Gradle scan flag
      shell: bash
      run: |-
        if [[ "${{ github.event.inputs.disable_scan }}" == "true" ]]; then
          echo "GRADLE_SCAN_FLAG=-Dorg.gradle.scan=false" >> "$GITHUB_ENV"
        else
          echo "GRADLE_SCAN_FLAG=" >> "$GITHUB_ENV"
        fi
    - name: Set build environment variables
      id: set-env
      shell: bash
      run: |
        # Priority: tag input > push tag > fallback (if not a version tag)
        TAG="${{ github.event.inputs.tag }}"
        TAG="${TAG:-${{ github.ref_name }}}"
        # Normalize: add v prefix if missing (allows input of "0.4.5" or "v0.4.5")
        [[ -n "$TAG" && "$TAG" =~ ^[0-9] ]] && TAG="v${TAG}"
        # If TAG doesn't look like a version tag (v*), generate manual version
        [[ ! "$TAG" =~ ^v[0-9] ]] && TAG="manual-$(date +%Y%m%d-%H%M%S)"
        
        # Get actual commit SHA from checked-out code (not github.sha which is dispatch trigger)
        COMMIT_SHA=$(git rev-parse HEAD)

        echo "Release version: ${TAG}"
        echo "Commit SHA: ${COMMIT_SHA}"
        {
          echo "BUILD_VERSION=${TAG}"
          echo "BUILD_COMMIT=${COMMIT_SHA}"
          echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
        } >> "$GITHUB_ENV"
        
        # Set outputs for downstream jobs
        {
          echo "build_version=${TAG}"
          echo "build_commit=${COMMIT_SHA}"
        } >> "$GITHUB_OUTPUT"
    - name: Validate Release Script
      run: ./tools/release.sh validate --version "${{ env.BUILD_VERSION }}"

    - name: Build with Release Script
      shell: bash
      run: |
        ./tools/release.sh build --version "${{ env.BUILD_VERSION }}"
        
    - name: Generate Checksums
      run: ./tools/release.sh checksums
    - name: Run Smoke Tests
      run: ./tools/release.sh smoke-test
    - name: Upload release artifacts
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: "release-artifacts-${{ matrix.os }}"
        path: dist/*
        retention-days: 7

  # Cross-platform smoke tests to verify JAR works on all supported platforms
  # TODO(#461): Migrate to JDK 21 baseline and drop JDK 17 support entirely.
  #   Temurin doesn't provide JDK 17 for Windows ARM, requiring matrix exclusions.
  #   JDK 21 is the current LTS and available on all platforms.
  #   See: https://github.com/albertocavalcante/groovy-devtools/issues/461
  smoke-test:
    name: Smoke Test (${{ matrix.os }}, JDK ${{ matrix.java }})
    needs: build-release
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04, ubuntu-24.04-arm, macos-15, windows-2022, windows-11-arm]
        java: [17, 21]
        exclude:
          # Temurin doesn't provide JDK 17 for Windows ARM â€” only JDK 21+ available
          - os: windows-11-arm
            java: 17
        include:
          # JDK 11 should fail due to bytecode version mismatch (target is JDK 17)
          - os: ubuntu-24.04
            java: 11
            expected_fail: true
    steps:
      - name: Download release artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          pattern: release-artifacts-*
          merge-multiple: true
          path: dist

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: ${{ matrix.java }}

      - name: Verify Java version
        run: java -version

      - name: Run smoke test
        id: smoke
        shell: bash
        continue-on-error: ${{ matrix.expected_fail == true }}
        run: |
          JAR_FILE=$(find dist -name "gls-*.jar" -type f | head -1)
          if [[ -z "$JAR_FILE" ]]; then
            echo "::error::No JAR file found in dist/"
            exit 1
          fi
          echo "Testing JAR: $JAR_FILE"
          java -jar "$JAR_FILE" --help
          echo "âœ… Smoke test passed!"

      - name: Verify expected failure (JDK 11)
        if: matrix.expected_fail == true
        shell: bash
        run: |
          if [[ "${{ steps.smoke.outcome }}" == "success" ]]; then
            echo "::error::JDK 11 smoke test unexpectedly succeeded! Check if bytecode target changed."
            exit 1
          fi
          echo "âœ… JDK 11 correctly failed with bytecode version mismatch"

  create-release:
    name: Create Release
    permissions:
      contents: write
      id-token: write       # For OIDC token (Sigstore signing)
      attestations: write   # For uploading attestations
    needs: [build-release, smoke-test]
    timeout-minutes: 15
    outputs:
      tag_name: ${{ steps.release_info.outputs.version }}
      version_no_v: ${{ steps.release_info.outputs.version_no_v }}
      is_prerelease: ${{ steps.release_info.outputs.is_prerelease }}
      is_draft: ${{ steps.release_info.outputs.is_draft }}
    runs-on: ${{ (github.event.inputs.runner_label == 'self-hosted' || vars.CI_RUNNER_LABEL == 'self-hosted') && 'self-hosted' || (github.event.inputs.runner_label == 'local-macos' || vars.CI_RUNNER_LABEL == 'local-macos') && fromJSON('["self-hosted", "local-macos", "groovy-lsp"]') || (github.event.inputs.runner_label == 'magalu' || vars.CI_RUNNER_LABEL == 'magalu') && fromJSON('["self-hosted", "magalu", "groovy-lsp"]') || 'ubuntu-24.04' }}
    if: "${{ !inputs.dry_run }}"
    steps:
    - name: Validate tag input
      if: github.event.inputs.tag != ''
      shell: bash
      env:
        TAG_INPUT: ${{ github.event.inputs.tag }}
      run: |
        # Validate tag matches expected version format (v1.2.3 or v1.2.3-rc.1 or vscode-groovy-v1.2.3)
        if [[ ! "$TAG_INPUT" =~ ^(v|vscode-groovy-v)?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
          echo "::error::Invalid tag format: $TAG_INPUT. Expected formats: v1.2.3, v1.2.3-rc.1, or vscode-groovy-v1.2.3"
          exit 1
        fi
        echo "Tag validation passed: $TAG_INPUT"

    - name: Determine checkout ref
      id: checkout_ref
      shell: bash
      env:
        TAG_INPUT: ${{ github.event.inputs.tag }}
        DEFAULT_REF: ${{ github.ref }}
      run: |
        # Use validated tag input or fall back to github.ref
        CHECKOUT_REF="${TAG_INPUT:-$DEFAULT_REF}"
        echo "ref=${CHECKOUT_REF}" >> "$GITHUB_OUTPUT"

    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        fetch-depth: 0
        ref: ${{ steps.checkout_ref.outputs.ref }}
        persist-credentials: false
    - name: Download all artifacts
      uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
      with:
        merge-multiple: true
        path: artifacts
    - name: Prepare release assets
      shell: bash
      run: |
        mkdir -p dist
        echo "Downloaded artifacts:"
        find artifacts -type f | sort

        # Move all artifacts to dist directory
        cp -r artifacts/* dist/ 2>/dev/null || true
        
        # Checksums are already generated by release script
        cat dist/checksums.txt || echo "No checksums found"

    # SLSA Level 3 Provenance Attestation
    - name: Generate provenance attestation for JAR
      uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
      with:
        subject-path: dist/gls-*.jar

    - name: Generate provenance attestation for VSIX
      uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
      with:
        subject-path: dist/*.vsix
      continue-on-error: true  # VSIX may not exist in all cases

    - name: Verify attestation
      shell: bash
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Verifying provenance attestation..."
        for file in dist/gls-*.jar; do
          if [[ -f "$file" ]]; then
            gh attestation verify "$file" --owner ${{ github.repository_owner }} || echo "::warning::Attestation verification skipped for $file"
          fi
        done
        echo "âœ… Attestation verification complete"
    - name: Generate release notes
      id: release_notes
      shell: bash
      run: |
        # Use VERSION from build-release job to ensure consistency
        VERSION="${{ needs.build-release.outputs.build_version }}"
        echo "Using version from build: ${VERSION}"

        cat > release-notes.md <<EOF
        ## Groovy DevTools ${VERSION}

        This release includes:
        - **gls** (Groovy Language Server) - Platform-independent JAR
        - **gvy** (IDE extension) - VS Code, Open VSX

        ### Installation

        Download and run the JAR:

        \`\`\`bash
        # Download JAR
        curl -LO https://github.com/${{ github.repository }}/releases/download/${VERSION}/gls-${VERSION#v}.jar

        # Verify checksum
        curl -LO https://github.com/${{ github.repository }}/releases/download/${VERSION}/checksums.txt
        sha256sum -c checksums.txt --ignore-missing

        # Run the Language Server (requires JDK 17+)
        java -jar gls-${VERSION#v}.jar
        \`\`\`

        ### Verify Attestation (Optional)

        All release artifacts include SLSA Level 3 provenance attestations:

        \`\`\`bash
        # Verify JAR attestation (requires gh CLI)
        gh attestation verify gls-${VERSION#v}.jar --owner albertocavalcante
        \`\`\`

        ### Requirements

        - **Java 17+** (JDK 17, 21, or later)
        - Works on all platforms: Linux, macOS, Windows (x64 and ARM64)

        ### Usage

        The Groovy Language Server provides IDE features for Groovy development including:
        - Code completion
        - Syntax highlighting
        - Error checking
        - Go to definition
        - Find references

        ### What's Changed

        <!-- GitHub will auto-generate this section -->

        ---

        **Full Changelog**: https://github.com/${{ github.repository }}/compare/v0.0.1...${VERSION}
        EOF
    - name: Determine release settings
      id: release_info
      shell: bash
      run: |
        # Use VERSION from build-release job to ensure consistency
        VERSION="${{ needs.build-release.outputs.build_version }}"
        echo "Using version from build: ${VERSION}"

        # Determine prerelease/draft status
        if [[ "$VERSION" == manual-* ]]; then
          IS_PRERELEASE=true
          IS_DRAFT=true
        elif [[ "$VERSION" =~ (-rc|-beta|-alpha) ]]; then
          IS_PRERELEASE=true
          IS_DRAFT=${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}
        else
          IS_PRERELEASE=false
          IS_DRAFT=${{ github.event_name == 'workflow_dispatch' && 'true' || 'false' }}
        fi

        {
          echo "version=${VERSION}"
          echo "version_no_v=${VERSION#v}"
          echo "is_prerelease=${IS_PRERELEASE}"
          echo "is_draft=${IS_DRAFT}"
        } >> "$GITHUB_OUTPUT"

        echo "Release settings:"
        echo "- Version: ${VERSION}"
        echo "- Prerelease: ${IS_PRERELEASE}"
        echo "- Draft: ${IS_DRAFT}"
    - name: Create GitHub release
      uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
      with:
        tag_name: "${{ steps.release_info.outputs.version }}"
        draft: "${{ steps.release_info.outputs.is_draft }}"
        prerelease: "${{ steps.release_info.outputs.is_prerelease }}"
        name: "Groovy DevTools ${{ steps.release_info.outputs.version }}"
        body_path: release-notes.md
        generate_release_notes: true
        files: |
          dist/*
        fail_on_unmatched_files: false
        make_latest: "${{ steps.release_info.outputs.is_prerelease == 'false' }}"
    - name: Release summary
      shell: bash
      run: |-
        echo "âœ… Release created successfully!"
        echo "ðŸ“¦ Version: ${{ steps.release_info.outputs.version }}"
        echo "ðŸ·ï¸ Tag: ${{ steps.release_info.outputs.version }}"
        echo "ðŸ“ Draft: ${{ steps.release_info.outputs.is_draft }}"
        echo "ðŸ”– Prerelease: ${{ steps.release_info.outputs.is_prerelease }}"
        echo ""
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_info.outputs.version }}"
        echo ""
        echo "ðŸ“‹ Artifacts included:"
        cd dist
        for file in *; do
          if [[ -f "$file" ]]; then
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
            echo "  - $file (${size} bytes)"
          fi
        done

  publish-homebrew:
    needs: create-release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    if: ${{ !inputs.dry_run }}
    steps:
      - name: Update Homebrew Formula
        uses: mislav/bump-homebrew-formula-action@56a283fa15557e9abaa4bdb63b8212abc68e655c # v3.6
        with:
          homebrew-tap: albertocavalcante/homebrew-tap
          formula-name: gls
          download-url: https://github.com/albertocavalcante/groovy-devtools/releases/download/${{ needs.create-release.outputs.tag_name }}/gls-${{ needs.create-release.outputs.version_no_v }}.jar
          commit-message: "chore: update gls to {{version}}"
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}

  # VS Code Extension publish (unified release - triggers on v* tags)
  publish-extension:
    name: Publish VS Code Extension
    needs: create-release
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: write

    defaults:
      run:
        working-directory: .

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ needs.create-release.outputs.tag_name }}
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: 24

      - name: Setup pnpm
        uses: pnpm/action-setup@9fd676a19091d4595eefd76e4bd31c97133911f1 # v4.2.0
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> "$GITHUB_ENV"

      - name: Cache pnpm store
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('editors/code/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Java
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          distribution: temurin
          java-version: 17

      - name: Install dependencies
        working-directory: editors/code
        run: pnpm install --frozen-lockfile
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download release artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          # We need any valid VSIX. Since artifacts are uploaded per-OS, 
          # we look for the one that likely contains it. 
          # To be robust, we fetch all and merge, or just use a stable name if we had one.
          # The build job uses: name: "release-artifacts-${{ matrix.os }}"
          # If we don't know which OS ran, download-artifact v4+ can download ALL if we omit name.
          pattern: release-artifacts-*
          merge-multiple: true
          path: dist
          
      - name: Publish to VS Code Marketplace
        run: npx @vscode/vsce publish -p ${{ secrets.VSCE_TOKEN }} --packagePath dist/*.vsix

      # Uncomment when ready to publish to Open VSX
      # - name: Publish to Open VSX Registry
      #   run: npx ovsx publish -p ${{ secrets.OVSX_TOKEN }}

      - name: Upload VSIX to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: dist/*.vsix
          tag_name: ${{ needs.create-release.outputs.tag_name }}
